<meta content=width=device-width name=viewport>
<style>
	@font-face{
		font-family:baseline;src:local(verdana);unicode-range:u+20
	}
	@font-face{
		font-family:yu gothic;src:local(yu gothic medium)
	}
	@font-face{
		font-family:yu gothic;font-weight:bold;src:local(yu gothic bold)
	}
	*{
		line-height:calc(1em + 8px);margin:unset
	}
	html,body{
		height:100%
	}
	body{
		background:#000;color:#fff;font-family:baseline,arial,yu gothic,sans-serif;font-kerning:none
	}
	br{
		display:none
	}
	canvas,video{
		display:block;height:100%;width:100%
	}
	canvas{
		object-fit:contain;position:absolute;top:0
	}
	#description{
		font-weight:bold;padding:12px 16px;position:absolute;top:0
	}
</style>
<title>INTLOOPライブラリー</title>
<video id=video playsinline>
</video>
<canvas id=drawingBuffer>
</canvas>
<div id=description>裏表紙のISBNバーコードにカメラを向けてください。（ISBNは、97 で始まる13桁）</div>
<script src=https://cdn.jsdelivr.net/npm/quagga>
</script>
<script type=module>
	video.srcObject=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})

	await new Promise(function $(resolve){
		video.videoWidth?resolve():setTimeout($,undefined,resolve)
	})
	const canvas=document.createElement("canvas")
	canvas.width=video.videoWidth
	canvas.height=video.videoHeight
	drawingBuffer.width=1.25*video.videoWidth
	drawingBuffer.height=1.25*video.videoHeight

	const constraits={decoder:{multiple:true,readers:["ean_reader"]},locator:{halfSample:true}}
	const reducer=(result,value,index)=>index%2?result+3*value:result+ +value
	const tester=/^97[89]\d{10}$/
	const isIsbn13=code=>tester.test(code) && code.slice(-1)==9-[...code.slice(0,-1)].reduce(reducer,-1)%10
	video.play()

	await async function $(){
		canvas.getContext("2d").drawImage(video,0,0)
		const results=await new Promise(resolve=>{
			constraits.src=canvas.toDataURL()
			Quagga.decodeSingle(constraits,resolve)
		})
		drawingBuffer.getContext("2d").clearRect(0,0,1.25*video.videoWidth,1.25*video.videoHeight)
		if(results!==undefined) for(const{box,codeResult}of results){
			drawingBuffer.getContext("2d").beginPath()
			drawingBuffer.getContext("2d").moveTo(...box[0])
			drawingBuffer.getContext("2d").lineTo(...box[1])
			drawingBuffer.getContext("2d").lineTo(...box[2])
			drawingBuffer.getContext("2d").lineTo(...box[3])
			drawingBuffer.getContext("2d").closePath()
			drawingBuffer.getContext("2d").strokeStyle=codeResult?"#f00":"#00f"
			drawingBuffer.getContext("2d").stroke()
			if(codeResult===undefined) continue
			if(!isIsbn13(codeResult.code)) continue
			video.pause()
			const response=await fetch("https://www.googleapis.com/books/v1/volumes?q=isbn:"+codeResult.code)
			const{items}=await response.json()
			for(const{volumeInfo}of items??[{volumeInfo:{}}]){
				const bookInfo=[]
				if(volumeInfo.title!==undefined) bookInfo.push("題名: "+volumeInfo.title)
				if(volumeInfo.authors!==undefined) bookInfo.push("著者: "+volumeInfo.authors.join("、"))
				bookInfo.push("ISBN: "+codeResult.code)
				if(!confirm("図書の内容は以下ですか?\n\n"+bookInfo.join("\n"))) continue
				const formUrl=new URL("https://docs.google.com")
				formUrl.pathname="forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform"
				formUrl.searchParams.append("usp","pp_url")
				formUrl.searchParams.append("entry.772749012",codeResult.code.replaceAll(/.$/g,""))
				formUrl.searchParams.append("entry.1369649637",new Date().toLocaleString("sv"))
				location=formUrl
			}
			video.play()
		}
		setTimeout($)
	}()
</script>