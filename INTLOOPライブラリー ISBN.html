<meta content=width=device-width name=viewport>
<style>
	@font-face{
		font-family:baseline;src:local(verdana);unicode-range:u+20
	}
	@font-face{
		font-family:yu gothic;src:local(yu gothic medium)
	}
	@font-face{
		font-family:yu gothic;font-weight:bold;src:local(yu gothic bold)
	}
	*{
		line-height:calc(1em + 8px);margin:unset
	}
	html,body{
		height:100%
	}
	body{
		background:#000;color:#fff;font-family:baseline,arial,yu gothic,sans-serif;font-kerning:none
	}
	#description{
		padding:12px 16px;position:absolute;top:0
	}
	video,canvas{
		display:block;max-height:100%;max-width:100%
	}
	canvas{
		position:absolute;top:0
	}
	br{
		display:none
	}
</style>
<title>INTLOOPライブラリー</title>
<div id=description><strong>裏表紙のISBNバーコードにカメラを向けてください。（ISBNは、97 で始まる13桁）</strong></div>
<script src="https://cdn.jsdelivr.net/npm/quagga"></script>
<script>
	let checker
	Quagga.init({
		inputStream:{type:"LiveStream",target:document.body},
		constraints:{facingMode:"environment"},
		decoder:{readers:["ean_reader"]} 
	},error=>{
		if(error) return console.log(error)
		Quagga.start()
	})
	Quagga.onProcessed(async result=>{
		const{ctx,dom}=Quagga.canvas
		ctx.overlay.clearRect(0,0,~~dom.overlay.width,~~dom.overlay.height)
		if(result===undefined) return
		for(const box of result.boxes){
			Quagga.ImageDebug.drawPath(box,{x:0,y:1},ctx.overlay,{color:"#00f",lineWidth:2})
		}
		if(result.box===undefined) return
		Quagga.ImageDebug.drawPath(result.box,{x:0,y:1},ctx.overlay,{color:"#f00",lineWidth:2})
		if(checker!==(checker=result.codeResult.code,checker)) return
		if(!/^97[89]\d{10}$/.test(result.codeResult.code)) return
		Quagga.pause();document.querySelector("video").pause()
		const response=await fetch("https://www.googleapis.com/books/v1/volumes?q=isbn:"+result.codeResult.code)
		const{items}=await response.json()
		if(items!==undefined){
			if(confirm("図書の内容は以下ですか?\n\n"+Object.entries({
				題名:items[0].volumeInfo.title,著者:items[0].volumeInfo.authors.join("、"),ISBN:result.codeResult.code
			}).map(entry=>entry.join(": ")).join("\n"))){
				//const response=await fetch(うんぬん)//借りているかを、スプレッドシートのGASにフェッチして確認
				open(true||await response.json()?
					"https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="+result.codeResult.code
				:"https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="+result.codeResult.code)//延長・返却用のもう一つのフォームURL
			}
			checker=undefined
		}
		document.querySelector("video").play();Quagga.start()
	})
</script>