<meta content=width=device-width name=viewport>
<style>
	@font-face{
		font-family:baseline;src:local(verdana);unicode-range:u+20
	}
	@font-face{
		font-family:yu gothic;src:local(yu gothic medium)
	}
	@font-face{
		font-family:yu gothic;font-weight:bold;src:local(yu gothic bold)
	}
	*{
		line-height:calc(1em + 8px);margin:unset
	}
	html,body{
		height:100%
	}
	body{
		background:#000;color:#fff;font-family:baseline,arial,yu gothic,sans-serif;font-kerning:none;
	}
	#description{
		font-weight:bold;padding:12px 16px;position:absolute;top:0
	}
	br,video{
		display:none
	}
	canvas{
		display:block;height:100%;object-fit:contain;width:100%
	}
</style>
<title>INTLOOPライブラリー</title>
<div id=description>裏表紙のISBNバーコードにカメラを向けてください。（ISBNは、97 で始まる13桁）</div>
<script src="https://cdn.jsdelivr.net/npm/quagga"></script>
<script>
	let checker,counter=0
	Quagga.init({
		inputStream:{target:document.body},constraints:{facingMode:"environment"},decoder:{readers:["ean_reader"]}
	},error=>{
		error?console.log(error):Quagga.start()
	})
	Quagga.onProcessed(async result=>{
		try{
			Quagga.canvas.ctx.overlay.drawImage(document.querySelector("video"),0,0,Quagga.canvas.dom.overlay.width,Quagga.canvas.dom.overlay.height,0,0,Quagga.canvas.dom.overlay.width,Quagga.canvas.dom.overlay.height)
			if(result===undefined) return
			for(const box of result.boxes){
				Quagga.ImageDebug.drawPath(box,{x:0,y:1},Quagga.canvas.ctx.overlay,{color:"#00f",lineWidth:1})
				//Quagga.ImageWrapper
			}
			if(result.box===undefined) return
			console.log(checker)
			Quagga.ImageDebug.drawPath(result.box,{x:0,y:1},Quagga.canvas.ctx.overlay,{color:"#f00",lineWidth:1})
			//Quagga.ImageWrapper
			if(checker!==(checker=result.codeResult.code,checker)) return counter=0,undefined
			if(++counter!==2) return
			if(!/^97[89]\d{10}$/.test(result.codeResult.code)) return
			Quagga.pause()
			document.querySelector("video").pause()
			const response=await fetch("https://www.googleapis.com/books/v1/volumes?q=isbn:"+result.codeResult.code)
			const{items}=await response.json()
			if(confirm("図書の内容は以下ですか?\n\n"+Object.entries({
				...items&&{題名:items[0].volumeInfo.title,著者:items[0].volumeInfo.authors.join("、")},ISBN:result.codeResult.code
			}).map(entry=>entry.join(": ")).join("\n"))){
				open("https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="+result.codeResult.code)
				/*
				const response=await fetch("https://script.google.com/macros/s/AKfycbx2Iksqz5JihaJKVJakdnP0E6K_15N4bzuEAvXGVaVFmA63BhQVw6pt6VuvZWYzlUWh/exec?isbn="+result.codeResult.code)
				const formUrl=await response.json()?
					"https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="//延長・返却用
				:"https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="//貸し出し用
				open(formUrl+result.codeResult.code)
				*/
			}
		} catch(error){
			description.innerText=error
		} finally{
			document.querySelector("video").play()
			Quagga.start()
		}
	})
</script>