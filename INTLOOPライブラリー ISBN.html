<meta content=width=device-width name=viewport>
<style>
	@font-face{
		font-family:baseline;src:local(verdana);unicode-range:u+20
	}
	@font-face{
		font-family:yu gothic;src:local(yu gothic medium)
	}
	@font-face{
		font-family:yu gothic;font-weight:bold;src:local(yu gothic bold)
	}
	*{
		line-height:calc(1em + 8px)
	}
	html,body{
		height:100%
	}
	body{
		background:#000;color:#fff;font-family:baseline,arial,yu gothic,sans-serif;font-kerning:none;margin:unset
	}
	#description{
		padding:12px 16px;
	}
	canvas,video{
		display:block;height:100%;width:100%
	}
	canvas{
		left:0;position:absolute;top:0
	}/*divの文字を、::beforeに入れる?*/
</style>
<title>INTLOOPライブラリー</title>
<div id=description><strong>裏表紙のISBNバーコードにカメラを向けてください。（ISBNは、97 で始まる13桁）</strong></div>
<script src="https://cdn.jsdelivr.net/npm/quagga"></script>
<script>
	const checker={}
	Quagga.init({
		inputStream:{type:"LiveStream",target:document.body},
		constraints:{facingMode:"environment"},
		decoder:{readers:["ean_reader"]} 
	},/**/async/**/error=>{
		if(error) return console.log(error)
		description.remove()
		Quagga.start()
	})
	Quagga.onProcessed(/*async*/result=>{
		if(result?.box===undefined) return
		const{ctx,dom}=Quagga.canvas
		ctx.overlay.clearRect(0,0,~~dom.overlay.width,~~dom.overlay.height)
		Quagga.ImageDebug.drawPath(result.box,{x:0,y:1},ctx.overlay,{color:"blue",lineWidth:2})
	})
	Quagga.onDetected(async result=>{
		checker[result.codeResult.code]=(checker[result.codeResult.code]||0)+1
		if(checker[result.codeResult.code]!=2/*0x10*/) return
		const response=await fetch("https://www.googleapis.com/books/v1/volumes?q=isbn:"+result.codeResult.code)
		const{items}=await response.json()
		if(confirm("図書の内容は以下ですか?\n\n"+Object.entries({
			題名:items[0].volumeInfo.title,著者:items[0].volumeInfo.authors.join("、"),ISBN:result.codeResult.code
		}).map(entry=>entry.join(": ")).join("\n"))){
			//const response=await fetch(うんぬん)//借りているかを、スプレッドシートのGASにフェッチして確認
			open(true||await response.json()?
				"https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="+result.codeResult.code
			:"https://docs.google.com/forms/d/e/1FAIpQLSdu_2j4p3ubst0eoFRZaHoSZEbFB2SJkvzbSlxkh6qJXCMcFw/viewform?usp=pp_url&entry.772749012="+result.codeResult.code)//延長・返却用のもう一つのフォームURL
		}
		for(const key in checker) delete checker[key]
	})
</script>