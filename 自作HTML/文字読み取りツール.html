<link href=style.css rel=stylesheet>
<meta content=width=device-width name=viewport>
<style>
	html,body{height:calc(100% - 16px)}
	div{background:#333;margin-bottom:16px;margin-top:16px;min-height:1em;overflow:scroll;padding:16px}
	div:has(>#source){height:calc(100% - 160px)}
	canvas{display:block;margin-right:auto}
	#source{cursor:crosshair;margin-left:auto}
	#pdfSize::placeholder{color:#f00}
</style>
<title>文字読み取りツール</title>
<input id=pdfSize placeholder=PDFの倍率（PDFを読み込むならば必須）>
<button id=selectButton>画像かPDFを選択</button>
<div>
	<canvas height=0 id=source width=0>
	</canvas>
</div>
<script src=https://mozilla.github.io/pdf.js/build/pdf.js></script>
<script src=https://unpkg.com/tesseract.js@v4.0.3/dist/tesseract.min.js></script>
<script type=module>
	const image=new Image
	image.onerror=()=>console.warn(event)/**/
	image.onload=()=>{
		source.width=event.target.width
		source.height=event.target.height
		source.getContext("2d").drawImage(event.target,0,0)
	}
	selectButton.onclick=async()=>{
		const inputElement=document.createElement("input")
		inputElement.type="file"
		await new Promise(resolve=>{
			inputElement.onchange=resolve
			inputElement.click()
		})
		const fileReader=new FileReader
		await new Promise(resolve=>{
			fileReader.onload=resolve
			fileReader.readAsDataURL(inputElement.files[0])
		})
		if(inputElement.files[0].type!="application/pdf"){
			image.src=fileReader.result
			return
		}
		if(!pdfSize.value) return alert("PDFの倍率が不正です。")
		const xxx=await window["pdfjs-dist/build/pdf"].getDocument(fileReader.result).promise
		console.warn(xxx)
		const proxy=await xxx.getPage(1)
		const viewport=proxy.getViewport({scale:4*pdfSize.value/3})
		source.height=viewport.height
		source.width=viewport.width
		await proxy.render({canvasContext:source.getContext("2d"),viewport:viewport}).promise
		image.src=source.toDataURL()
	}
	let offsetX
	let offsetY
	onmousemove=()=>{
		if(~event.buttons&0b1) return
		if(!onselectstart) return
		getSelection().removeAllRanges()
		const{x,y}=source.getBoundingClientRect()
		source.getContext("2d").drawImage(image,0,0)
		source.getContext("2d").beginPath()
		source.getContext("2d").lineWidth=8
		source.getContext("2d").moveTo(offsetX-4*Math.sign(event.x-x-offsetX),offsetY-4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").lineTo(event.x-x+4*Math.sign(event.x-x-offsetX),offsetY-4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").lineTo(event.x-x+4*Math.sign(event.x-x-offsetX),event.y-y+4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").lineTo(offsetX-4*Math.sign(event.x-x-offsetX),event.y-y+4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").closePath()
		source.getContext("2d").strokeStyle="#00fa"
		source.getContext("2d").stroke()
	}
	onmouseup=async()=>{
		if(event.button) return
		if(!onselectstart) return
		if(event.offsetX==offsetX) return
		if(event.offsetY==offsetY) return
		onselectstart=null
		const{x,y}=source.getBoundingClientRect()

		source.getContext("2d").drawImage(image,0,0)
		source.getContext("2d").beginPath()
		source.getContext("2d").lineWidth=8
		source.getContext("2d").moveTo(offsetX-4*Math.sign(event.x-x-offsetX),offsetY-4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").lineTo(event.x-x+4*Math.sign(event.x-x-offsetX),offsetY-4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").lineTo(event.x-x+4*Math.sign(event.x-x-offsetX),event.y-y+4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").lineTo(offsetX-4*Math.sign(event.x-x-offsetX),event.y-y+4*Math.sign(event.y-y-offsetY))
		source.getContext("2d").closePath()
		source.getContext("2d").strokeStyle="#f00a"
		source.getContext("2d").stroke()

		let x1=Math.max(0,Math.min(offsetX,event.x-x))
		let y1=Math.max(0,Math.min(offsetY,event.y-y))
		let range=document.createElement("canvas")
		range.width=Math.min(Math.max(offsetX,event.x-x),source.width) - Math.max(0,Math.min(offsetX,event.x-x))
		range.height=Math.min(Math.max(offsetY,event.y-y),source.width) - Math.max(0,Math.min(offsetY,event.y-y))
		offsetX=undefined
		offsetY=undefined
		range.getContext("2d").drawImage(image,x1,y1,range.width,range.height,0,0,range.width,range.height)
		await async function(){
			const{data:{text}}=await Tesseract.recognize(range.toDataURL())
			if(!text.trimEnd()) return
			await navigator.clipboard.writeText(text.trimEnd())
			alert(text.trimEnd())
		}().catch(alert)
	}
	source.onmousedown=()=>{
		if(event.button) return
		onselectstart=()=>false
		undefined,{offsetX,offsetY}=event
	}
</script>